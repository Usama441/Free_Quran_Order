<% content_for :title, "Edit Quran - Admin" %>

    <div class="flex justify-between items-center mb-6">
      <h2 class="text-3xl font-bold text-green-700 flex items-center space-x-2">
        <i class="fas fa-edit"></i><span>Edit Quran</span>
      </h2>
      <%= link_to admin_qurans_path, class: "bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition flex items-center space-x-2" do %>
        <i class="fas fa-arrow-left"></i><span>Back to List</span>
      <% end %>
    </div>

    <div class="bg-white shadow-lg rounded-xl p-6">
      <%= form_with model: @quran, url: admin_quran_path(@quran), method: :patch, class: "space-y-6" do |f| %>
        <% if @quran.errors.any? %>
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <h3 class="text-red-800 font-semibold mb-2">Please fix the following errors:</h3>
            <ul class="list-disc list-inside text-red-700">
              <% @quran.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Title -->
          <div>
            <%= f.label :title, "Book Title", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.text_field :title, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500", placeholder: "e.g. The Holy Quran - English Translation" %>
          </div>

          <!-- Writer -->
          <div>
            <%= f.label :writer, "Author/Translator", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.text_field :writer, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500", placeholder: "e.g. Dr. Muhammad Muhsin Khan" %>
          </div>

          <!-- Translation -->
          <div>
            <%= f.label :translation, "Language/Translation", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.select :translation, [
              ["English", "english"],
              ["Urdu", "urdu"],
              ["French", "french"],
              ["Spanish", "spanish"],
              ["Arabic", "arabic"]
            ], {}, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" %>
          </div>

          <!-- Pages -->
          <div>
            <%= f.label :pages, "Number of Pages", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.number_field :pages, min: 1, max: 5000, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500", placeholder: "e.g. 604" %>
          </div>

          <!-- Stock -->
          <div>
            <%= f.label :stock, "Stock Quantity", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.number_field :stock, min: 0, max: 10000, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500", placeholder: "e.g. 500" %>
          </div>
        </div>

        <!-- Images Section -->
        <div class="md:col-span-2">
          <%= f.label "Quran Images (Up to 5 images)", class: "block text-sm font-medium text-gray-700 mb-3" %>

          <!-- Current Images Display -->
          <% if @quran.images.attached? %>
            <div class="mb-4">
              <h5 class="text-sm font-medium text-gray-800 mb-2">Current Images:</h5>
              <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                <% @quran.images.each do |image| %>
                  <div class="relative group">
                    <%= image_tag rails_blob_path(image, only_path: true), class: "w-full h-24 object-cover rounded border" %>
                    <button type="button"
                            onclick="removeImage('<%= image.blob.signed_id %>', '<%= image.filename %>')"
                            class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">
                      Ã—
                    </button>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- Add New Images -->
          <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
            <div class="text-center">
              <i class="fas fa-cloud-upload-alt text-gray-400 text-2xl mb-2"></i>
              <p class="text-gray-600 mb-2">Drop new images here or click to browse</p>
              <p class="text-sm text-gray-500">(JPG, PNG, GIF, WebP - Max 5 images total)</p>
              <%= f.file_field :images, multiple: true, accept: "image/*", class: "hidden", id: "image-upload" %>
              <label for="image-upload" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 cursor-pointer inline-block">
                Select Images
              </label>
            </div>
          </div>

          <!-- Image Preview -->
          <div id="image-preview" class="mt-3 hidden">
            <p class="text-sm font-medium text-gray-700 mb-2">Selected Images Preview:</p>
            <div id="preview-images" class="grid grid-cols-2 md:grid-cols-5 gap-3"></div>
          </div>
        </div>

        <!-- Description -->
        <div class="md:col-span-2">
          <%= f.label :description, "Description", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.text_area :description, rows: 4, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500", placeholder: "Detailed description of the Quran book..." %>
        </div>

        <!-- Preview -->
        <div class="md:col-span-2 bg-gray-50 p-4 rounded-lg">
          <h4 class="font-semibold text-gray-800 mb-2">Preview:</h4>
          <div class="text-sm text-gray-600">
            <p><strong>Title:</strong> <span id="preview-title"><%= @quran.title.presence || 'Will be updated' %></span></p>
            <p><strong>Author:</strong> <span id="preview-writer"><%= @quran.writer.presence || 'Will be updated' %></span></p>
            <p><strong>Pages:</strong> <span id="preview-pages"><%= @quran.pages.presence || 'Will be updated' %></span></p>
            <p><strong>Stock:</strong> <span id="preview-stock"><%= @quran.stock.presence || 'Will be updated' %></span></p>
            <p><strong>Language:</strong> <span id="preview-translation" class="capitalize"><%= @quran.translation.presence || 'Will be updated' %></span></p>
          </div>
        </div>

<!-- Form Actions -->
<div class="flex justify-end space-x-4 pt-6 border-t">
  <button type="button" onclick="removeAllImages()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition" id="remove-all-btn" <%= 'hidden' if !@quran.images.attached? %>>
    Remove All Images
  </button>
  <%= link_to "Cancel", admin_qurans_path, class: "bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition" %>
  <%= f.submit "Update Quran",
              class: "bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition flex items-center space-x-2",
              data: { disable_with: "Updating..." } %>
</div>

<!-- Hidden fields for image removal -->
<div id="remove-images-container"></div>
  <% end %>
</div>
 
<!--Image preloading and optimization functions will be added here if needed -->

<% content_for :page_scripts do %>

<!-- Image Management JavaScript -->
<script>
    let imagesToRemove = [];

    function removeImage(imageId, filename) {
        if (confirm(`Remove image "${filename}"?`)) {
            // Add to removal list
            imagesToRemove.push(imageId);

            // Add hidden input to form
            const container = document.getElementById('remove-images-container');
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'remove_image[]';
            hiddenInput.value = imageId;
            container.appendChild(hiddenInput);

            // Remove image from display
            event.target.closest('.relative').remove();

            // Show/hide remove all button
            checkRemoveAllButton();
        }
    }

    function removeAllImages() {
        if (confirm('Remove all images from this Quran?')) {
            // Get all current images
            const imageElements = document.querySelectorAll('.relative.group');
            const imageIds = [];

            imageElements.forEach(element => {
                const button = element.querySelector('button[onclick*="removeImage"]');
                if (button) {
                    const onclickAttr = button.getAttribute('onclick');
                    const match = onclickAttr.match(/removeImage\('([^']*)'/);
                    if (match && match[1]) {
                        imageIds.push(match[1]);
                        // Immediately remove from UI
                        element.remove();
                    }
                }
            });

            // Add all to removal list
            imagesToRemove = imageIds;
            const container = document.getElementById('remove-images-container');

            imageIds.forEach(imageId => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'remove_image[]';
                hiddenInput.value = imageId;
                container.appendChild(hiddenInput);
            });

            // Grid is already cleared by individual removals above
            checkRemoveAllButton();
        }
    }

    function checkRemoveAllButton() {
        const button = document.getElementById('remove-all-btn');
        const currentImages = document.querySelectorAll('.relative.group');
        if (currentImages.length === 0) {
            button.classList.add('hidden');
        } else {
            button.classList.remove('hidden');
        }
    }

    // File upload preview
    document.getElementById('image-upload').addEventListener('change', function(e) {
        const files = e.target.files;
        const previewContainer = document.getElementById('preview-images');
        const previewDiv = document.getElementById('image-preview');

        // Clear previous previews
        previewContainer.innerHTML = '';

        // Show preview container
        previewDiv.classList.remove('hidden');

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'relative';
                    imgDiv.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-24 object-cover rounded border">
                        <span class="absolute top-1 right-1 bg-blue-600 text-white text-xs px-1 rounded">${file.name.substring(0, 8)}...</span>
                    `;
                    previewContainer.appendChild(imgDiv);
                };
                reader.readAsDataURL(file);
            }
        }
    });

    // Live preview update
    document.addEventListener('input', function(e) {
        const target = e.target;
        const previewElement = document.getElementById('preview-' + target.name.replace('quran[', '').replace(']', ''));
        if (previewElement && target.tagName !== 'SELECT') {
            previewElement.textContent = target.value || 'Will be updated';
        }
    });

    document.addEventListener('change', function(e) {
        const target = e.target;
        const previewElement = document.getElementById('preview-' + target.name.replace('quran[', '').replace(']', ''));
        if (previewElement && target.tagName === 'SELECT') {
            previewElement.textContent = target.value || 'Will be updated';
        }
    });

    // Initialize state
    document.addEventListener('DOMContentLoaded', function() {
        checkRemoveAllButton();
    });
</script>

<% end %>
