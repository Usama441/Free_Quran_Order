<% content_for :title, "Quran Orders Dashboard" %>

    <%= turbo_stream_from "dashboard_stats" %>

  <h2 class="text-3xl font-bold text-green-700 mb-6 flex items-center space-x-2">
      <i class="fas fa-chart-pie"></i><span>Dashboard Overview</span>
    </h2>

    <!-- Period Selector -->
    <div class="bg-white shadow-md rounded-xl p-4 mb-6">
      <h4 class="text-lg font-semibold text-green-700 mb-3">Select Time Period for Charts:</h4>
      <div class="flex space-x-2 flex-wrap">
        <%= link_to admin_dashboard_path(period: 'day'), class: "px-4 py-2 rounded-lg font-medium transition #{(@time_period == 'day') ? 'bg-green-600 text-white' : 'bg-green-100 text-green-700 hover:bg-green-200'}" do %>
          <i class="fas fa-calendar-day"></i> Daily (30 Days)
        <% end %>
        <%= link_to admin_dashboard_path(period: 'week'), class: "px-4 py-2 rounded-lg font-medium transition #{(@time_period == 'week') ? 'bg-green-600 text-white' : 'bg-green-100 text-green-700 hover:bg-green-200'}" do %>
          <i class="fas fa-calendar-week"></i> Weekly (6 Months)
        <% end %>
        <%= link_to admin_dashboard_path(period: 'month'), class: "px-4 py-2 rounded-lg font-medium transition #{(@time_period == 'month') ? 'bg-green-600 text-white' : 'bg-green-100 text-green-700 hover:bg-green-200'}" do %>
          <i class="fas fa-calendar-alt"></i> Monthly (12 Months)
        <% end %>
        <%= link_to admin_dashboard_path(period: 'year'), class: "px-4 py-2 rounded-lg font-medium transition #{(@time_period == 'year') ? 'bg-green-600 text-white' : 'bg-green-100 text-green-700 hover:bg-green-200'}" do %>
          <i class="fas fa-calendar-star"></i> Yearly (10 Years)
        <% end %>
      </div>
    </div>

    <!-- Stats Cards -->
    <%= turbo_frame_tag "stats_cards", class: "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10" do %>
      <div class="bg-white shadow-md rounded-xl p-6 border-l-4 border-green-600">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-gray-500 text-sm">Total Orders</p>
            <h3 class="text-2xl font-bold"><%= @total_orders %></h3>
          </div>
          <i class="fas fa-receipt text-green-600 text-3xl"></i>
        </div>
      </div>
      <div class="bg-white shadow-md rounded-xl p-6 border-l-4 border-green-600">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-gray-500 text-sm">Countries Served</p>
            <h3 class="text-2xl font-bold"><%= @countries_served %></h3>
          </div>
          <i class="fas fa-globe-asia text-green-600 text-3xl"></i>
        </div>
      </div>
      <div class="bg-white shadow-md rounded-xl p-6 border-l-4 border-green-600">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-gray-500 text-sm">Qurans Distributed</p>
            <h3 class="text-2xl font-bold"><%= @qurans_distributed %></h3>
          </div>
          <i class="fas fa-book-quran text-green-600 text-3xl"></i>
        </div>
      </div>
      <div class="bg-white shadow-md rounded-xl p-6 border-l-4 border-green-600">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-gray-500 text-sm">Stock Remaining</p>
            <h3 class="text-2xl font-bold"><%= @stock_remaining %></h3>
          </div>
          <i class="fas fa-warehouse text-green-600 text-3xl"></i>
        </div>
      </div>
    <% end %>

    <!-- Charts -->
    <%= turbo_frame_tag "charts_section", class: "grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10" do %>
      <div class="bg-white shadow-lg rounded-xl p-6">
        <h3 class="text-xl font-semibold text-green-700 mb-4"><%= @time_period.capitalize %> Orders Trend</h3>
        <canvas id="ordersChart"></canvas>
      </div>
      <div class="bg-white shadow-lg rounded-xl p-6">
        <h3 class="text-xl font-semibold text-green-700 mb-4">Stock Level by Translation</h3>
        <canvas id="stockChart"></canvas>
      </div>
    <% end %>

    <!-- Additional Analytics Section -->
    <%= turbo_frame_tag "analytics_section", class: "grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10" do %>
      <!-- Top Countries -->
      <div class="bg-white shadow-lg rounded-xl p-6">
        <h3 class="text-xl font-semibold text-green-700 mb-4">Top Countries by Orders</h3>
        <div class="space-y-3">
          <% @top_countries.each_with_index do |(country, count), index| %>
            <div class="flex justify-between items-center p-2 rounded bg-green-50">
              <div class="flex items-center space-x-3">
                <span class="text-lg font-bold text-green-600">#<%= index + 1 %></span>
                <span class="font-medium"><%= country %></span>
              </div>
              <span class="font-bold text-green-700"><%= count %></span>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Translation Popularity -->
      <div class="bg-white shadow-lg rounded-xl p-6">
        <h3 class="text-xl font-semibold text-green-700 mb-4">Stock by Translation</h3>
        <div class="space-y-3">
          <% @quran_translations.each do |(translation, stock)| %>
            <div class="flex justify-between items-center p-2 rounded bg-blue-50">
              <span class="font-medium capitalize"><%= translation %></span>
              <span class="font-bold text-blue-700"><%= stock %> units</span>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Recent Orders -->
      <div class="bg-white shadow-lg rounded-xl p-6">
        <h3 class="text-xl font-semibold text-green-700 mb-4">Recent Orders</h3>
        <div class="space-y-3 max-h-64 overflow-y-auto">
          <% @recent_orders.each do |order| %>
            <div class="flex justify-between items-center p-2 rounded bg-gray-50">
              <div>
                <div class="font-medium text-sm"><%= order.full_name %></div>
                <div class="text-xs text-gray-500"><%= order.city %>, <%= order.country_code %></div>
              </div>
              <div class="text-right">
                <div class="font-bold text-green-700">x<%= order.quantity %></div>
                <div class="text-xs text-gray-500"><%= time_ago_in_words(order.created_at) %></div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Heatmap -->
    <%= turbo_frame_tag "heatmap_section", class: "bg-white shadow-lg rounded-xl p-6" do %>
      <h3 class="text-xl font-semibold text-green-700 mb-4">Global Quran Orders Heatmap</h3>
      <div class="mb-4 flex justify-between items-center">
        <span class="text-sm text-gray-600">Click on markers to see order details</span>
        <div class="flex space-x-2">
          <span class="flex items-center text-xs"><span class="w-3 h-3 bg-red-500 rounded-full mr-1"></span>>900 orders</span>
          <span class="flex items-center text-xs"><span class="w-3 h-3 bg-orange-500 rounded-full mr-1"></span>600-900 orders</span>
          <span class="flex items-center text-xs"><span class="w-3 h-3 bg-green-500 rounded-full mr-1"></span><600 orders</span>
        </div>
      </div>
      <div id="map" class="h-96 rounded-lg"></div>
    <% end %>

    <!-- Performance Metrics -->
    <%= turbo_frame_tag "performance_section", class: "grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10" do %>
      <!-- Conversion Funnel -->
      <div class="bg-white shadow-lg rounded-xl p-6">
        <h3 class="text-xl font-semibold text-green-700 mb-4">Order Conversion Funnel</h3>
        <div class="space-y-4">
          <div class="flex justify-between items-center">
            <span>Website Visitors</span>
            <span class="font-bold"><%= (@page_views || 1250) %></span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="bg-green-600 h-2 rounded-full" style="width: 100%"></div>
          </div>

          <div class="flex justify-between items-center">
            <span>Order Form Views</span>
            <span class="font-bold"><%= (@form_views || @total_orders * 3).round %></span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="bg-green-600 h-2 rounded-full" style="width: #{(@total_orders.to_f / (@form_views || @total_orders * 3) * 100).round}%"></div>
          </div>

          <div class="flex justify-between items-center">
            <span>Completed Orders</span>
            <span class="font-bold"><%= @total_orders %></span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="bg-green-600 h-2 rounded-full" style="width: #{(@total_orders.to_f / (@page_views || 1250) * 100).round}%"></div>
          </div>
        </div>
      </div>

      <!-- Stock Alert -->
      <div class="bg-white shadow-lg rounded-xl p-6">
        <h3 class="text-xl font-semibold text-green-700 mb-4">Stock Alerts</h3>
        <div class="space-y-3">
          <% @low_stock_items.each do |quran| %>
            <div class="flex justify-between items-center p-2 rounded bg-red-50 border-l-4 border-red-500">
              <span class="font-medium"><%= quran.title %></span>
              <span class="font-bold text-red-600"><%= quran.stock %> left</span>
            </div>
          <% end %>
          <% if @low_stock_items.empty? %>
            <div class="text-center text-green-600 py-4">
              <i class="fas fa-check-circle text-2xl"></i>
              <p class="mt-2">All items well stocked!</p>
            </div>
          <% end %>
        </div>

        <div class="mt-6">
          <h4 class="font-semibold text-gray-700 mb-2">Quick Actions</h4>
          <div class="flex space-x-2">
            <%= link_to admin_qurans_path, class: "bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600 transition" do %>
              <i class="fas fa-plus"></i> Add Stock
            <% end %>
            <%= link_to "#", class: "bg-green-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-600 transition" do %>
              <i class="fas fa-shopping-cart"></i> Bulk Order
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

<% content_for :page_scripts do %>

<script>
    // Function to update chart dynamically
    function updateCharts(timePeriod, labels, data, stockLabels, stockData, heatmapData) {
        // Update title
        document.querySelector('#charts_section').querySelector('h3').textContent = timePeriod.charAt(0).toUpperCase() + timePeriod.slice(1) + ' Orders Trend';

        // Destroy existing chart if it exists
        if (window.ordersChart) {
            window.ordersChart.destroy();
        }

        // Create new chart
        const ordersCtx = document.getElementById("ordersChart").getContext("2d");
        window.ordersChart = new Chart(ordersCtx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [{
                    label: "Orders",
                    data: data,
                    borderColor: "#16a34a",
                    backgroundColor: "rgba(22,163,74,0.1)",
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });

        // Update heatmap
        updateHeatmap(heatmapData);
    }

    // Function to update heatmap
    function updateHeatmap(orders) {
        const mapElement = document.getElementById("map");
        if (mapElement._leaflet_id) {
            mapElement._leaflet_id = null;
        }

        const map = L.map("map").setView([20, 0], 2);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "© OpenStreetMap contributors"
        }).addTo(map);

        orders.forEach(order => {
            if (order.lat && order.lng) {
                const color = order.count > 900 ? "red" : (order.count > 600 ? "orange" : "green");
                const radius = Math.max(8, Math.min(20, order.count / 10)); // Scale radius based on orders
                L.circleMarker([order.lat, order.lng], {
                    radius: radius,
                    fillColor: color,
                    color: color,
                    weight: 2,
                    fillOpacity: 0.7
                }).addTo(map).bindPopup(`<b>${order.country}</b><br>Orders: ${order.count}`);
            }
        });
    }

    // Initial chart load
    const ordersCtx = document.getElementById("ordersChart").getContext("2d");
    window.ordersChart = new Chart(ordersCtx, {
        type: "line",
        data: {
            labels: <%= raw @labels.to_json %>,
            datasets: [{
                label: "Orders",
                data: <%= @orders_data ? raw(@orders_data.values.to_json) : raw([].to_json) %>,
                borderColor: "#16a34a",
                backgroundColor: "rgba(22,163,74,0.1)",
                fill: true,
                tension: 0.4,
                pointRadius: 5
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    // Stock Chart (static)
    const stockCtx = document.getElementById("stockChart").getContext("2d");
    new Chart(stockCtx, {
        type: "bar",
        data: {
            labels: <%= raw @stock_by_translation.keys.to_json %>,
            datasets: [{
                label: "Stock Remaining",
                data: <%= raw @stock_by_translation.values.to_json %>,
                backgroundColor: "#16a34a"
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    // Initial Heatmap
    const map = L.map("map").setView([20, 0], 2);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    const heatmapOrders = <%= raw @orders_heatmap.to_json %>;
    heatmapOrders.forEach(order => {
        if (order.lat && order.lng) {
            const color = order.count > 900 ? "red" : (order.count > 600 ? "orange" : "green");
            const radius = Math.max(8, Math.min(20, order.count / 10));
            L.circleMarker([order.lat, order.lng], {
                radius: radius,
                fillColor: color,
                color: color,
                weight: 2,
                fillOpacity: 0.7
            }).addTo(map).bindPopup(`<b>${order.country}</b><br>Orders: ${order.count}`);
        }
    });

    // Auto-refresh every 30 seconds
    setInterval(function() {
        location.reload();
    }, <%= auto_refresh_interval * 1000%>);
</script>

<% end %>