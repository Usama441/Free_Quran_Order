<!-- app/views/admin/orders/show.html.erb -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order #<%= @order.id %> - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    rel="stylesheet"
    />
</head>
<body class="bg-gray-50 text-gray-800">
<div class="flex h-screen">
  <!-- Sidebar -->
  <aside class="w-64 bg-green-700 text-white flex flex-col">
    <div class="p-6 text-center border-b border-green-600">
      <h1 class="text-2xl font-bold">Admin Dashboard</h1>
    </div>
    <nav class="flex-1 p-4 space-y-3">
      <%= link_to admin_dashboard_path, class: "flex items-center space-x-2 p-3 rounded-lg hover:bg-green-600 transition" do %>
        <i class="fas fa-chart-line"></i><span>Dashboard</span>
      <% end %>
      <%= link_to admin_qurans_path, class: "flex items-center space-x-2 p-3 rounded-lg hover:bg-green-600 transition" do %>
        <i class="fas fa-book-quran"></i><span>Quran Management</span>
      <% end %>
      <%= link_to admin_orders_path, class: "flex items-center space-x-2 p-3 rounded-lg hover:bg-green-600 transition bg-gray-600" do %>
        <i class="fas fa-shopping-cart"></i><span>Order Management</span>
      <% end %>
      <div class="pt-4">
        <p class="text-xs text-green-300 uppercase font-semibold mb-2">Analytics</p>
        <%= link_to admin_order_analytics_path, class: "flex items-center space-x-2 p-3 rounded-lg hover:bg-green-600 transition" do %>
          <i class="fas fa-chart-line"></i><span>Order Analytics</span>
        <% end %>
        <%= link_to admin_customer_analytics_path, class: "flex items-center space-x-2 p-3 rounded-lg hover:bg-green-600 transition" do %>
          <i class="fas fa-users"></i><span>Customer Insights</span>
        <% end %>
        <%= link_to admin_geographic_analytics_path, class: "flex items-center space-x-2 p-3 rounded-lg hover:bg-green-600 transition" do %>
          <i class="fas fa-globe"></i><span>Geographic Data</span>
        <% end %>
        <%= link_to admin_reports_path, class: "flex items-center space-x-2 p-3 rounded-lg hover:bg-green-600 transition" do %>
          <i class="fas fa-chart-bar"></i><span>Reports</span>
        <% end %>
      </div>
      <div class="pt-4">
        <p class="text-xs text-green-300 uppercase font-semibold mb-2">Settings</p>
        <%= link_to admin_configuration_path, class: "flex items-center space-x-2 p-3 rounded-lg hover:bg-green-600 transition" do %>
          <i class="fas fa-cog"></i><span>Configuration</span>
        <% end %>
        <%= link_to admin_notifications_path, class: "flex items-center space-x-2 p-3 rounded-lg hover:bg-green-600 transition" do %>
          <i class="fas fa-envelope"></i><span>Notifications</span>
        <% end %>
      </div>
      <!-- Back to Site -->
      <%= link_to root_path, class: "flex items-center space-x-2 p-3 rounded-lg bg-green-600 hover:bg-green-500 transition mt-8" do %>
        <i class="fas fa-home"></i><span>Back to Site</span>
      <% end %>
    </nav>
    <footer class="p-4 text-center border-t border-green-600">
      <p class="text-sm">&copy; 2025 Free Quran Project</p>
    </footer>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-8 overflow-y-auto">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-3xl font-bold text-green-700 flex items-center space-x-2">
        <i class="fas fa-eye"></i><span>Order #<%= @order.id %> Details</span>
      </h2>
      <div class="flex space-x-3">
        <%= link_to admin_orders_path, class: "bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition flex items-center space-x-2" do %>
          <i class="fas fa-arrow-left"></i><span>Back to Orders</span>
        <% end %>
        <button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center space-x-2">
          <i class="fas fa-print"></i><span>Print</span>
        </button>
      </div>
    </div>

    <!-- Flash Messages -->
    <% if notice %>
      <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6">
        <%= notice %>
      </div>
    <% end %>

    <% if alert %>
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
        <%= alert %>
      </div>
    <% end %>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column: Order Details -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Order Status Card -->
        <div class="bg-white shadow-lg rounded-xl p-6">
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="text-xl font-semibold text-gray-800">Order Status</h3>
              <div class="flex items-center mt-2">
                <div class="flex items-center">
                  <% ['pending', 'processing', 'shipped', 'delivered'].each_with_index do |status, index| %>
                    <% current_index = { 'pending' => 0, 'processing' => 1, 'shipped' => 2, 'delivered' => 3 }[@order.status] || -1 %>
                    <div class="flex items-center">
                      <div class="w-3 h-3 rounded-full <%= index <= current_index ? 'bg-green-500' : 'bg-gray-300' %>"></div>
                      <% unless status == 'delivered' %>
                        <div class="w-8 h-0.5 <%= index < current_index ? 'bg-green-500' : 'bg-gray-300' %>"></div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
              <div class="flex justify-between mt-2 text-sm">
                <span class="text-gray-600">Placed</span>
                <span class="text-gray-600">Processing</span>
                <span class="text-gray-600">Shipped</span>
                <span class="text-gray-600">Delivered</span>
              </div>
            </div>
            <div class="text-right">
              <span class="px-3 py-1 text-sm font-semibold rounded-full <%=
                case @order.status
                when 'pending' then 'bg-red-100 text-red-800'
                when 'processing' then 'bg-yellow-100 text-yellow-800'
                when 'shipped' then 'bg-blue-100 text-blue-800'
                when 'delivered' then 'bg-green-100 text-green-800'
                when 'cancelled' then 'bg-red-100 text-red-800'
                else 'bg-gray-100 text-gray-800'
                end
              %>">
                <%= @order.status&.titleize || "Unknown" %>
              </span>
              <div class="mt-2">
                <select onchange="updateOrderStatus(<%= @order.id %>, this.value)" class="text-sm border border-gray-300 rounded-md px-2 py-1 focus:ring-2 focus:ring-green-500 outline-none">
                  <option value="<%= @order.status %>"><%= @order.status&.titleize || @order.status || "Unknown" %> (Current)</option>
                  <option value="pending">Pending</option>
                  <option value="processing">Processing</option>
                  <option value="shipped">Shipped</option>
                  <option value="delivered">Delivered</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Order Timeline -->
          <div class="border-t pt-4">
            <h4 class="font-semibold text-gray-800 mb-3">Order Timeline</h4>
            <div class="space-y-3">
              <div class="flex items-start">
                <div class="flex-shrink-0 w-2 h-2 bg-green-500 rounded-full mt-2"></div>
                <div class="ml-3">
                  <p class="text-sm font-medium text-gray-800">Order Created</p>
                  <p class="text-sm text-gray-600"><%= @order.created_at.strftime('%B %d, %Y at %I:%M %p') %></p>
                </div>
              </div>

              <% if @order.updated_at != @order.created_at %>
                <div class="flex items-start">
                  <div class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                  <div class="ml-3">
                    <p class="text-sm font-medium text-gray-800">Status Updated</p>
                    <p class="text-sm text-gray-600"><%= @order.updated_at.strftime('%B %d, %Y at %I:%M %p') %></p>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Customer Information -->
        <div class="bg-white shadow-lg rounded-xl p-6">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-user text-green-600 mr-2"></i>
            Customer Information
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 class="font-medium text-gray-700 mb-2">Personal Details</h4>
              <div class="space-y-2">
                <p><span class="font-medium">Full Name:</span> <%= @order.full_name %></p>
                <p><span class="font-medium">Email:</span> <a href="mailto:<%= @order.email %>" class="text-blue-600 hover:text-blue-800"><%= @order.email %></a></p>
                <p><span class="font-medium">Phone:</span> <%= @order.phone %></p>
                <p><span class="font-medium">Country:</span> <%= @order.country_code %></p>
              </div>
            </div>
            <div>
              <h4 class="font-medium text-gray-700 mb-2">Address Details</h4>
              <div class="space-y-2">
                <p><span class="font-medium">City:</span> <%= @order.city %></p>
                <p><span class="font-medium">State/Province:</span> <%= @order.state %></p>
                <p><span class="font-medium">Postal Code:</span> <%= @order.postal_code %></p>
                <p><span class="font-medium">Address:</span> <%= @order.address %></p>
              </div>
            </div>
          </div>

          <% if @order.note.present? %>
            <div class="mt-4 pt-4 border-t">
              <h4 class="font-medium text-gray-700 mb-2">Special Notes</h4>
              <p class="text-gray-600 bg-gray-50 p-3 rounded-lg"><%= @order.note %></p>
            </div>
          <% end %>
        </div>

        <!-- Order Items -->
        <div class="bg-white shadow-lg rounded-xl p-6">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-book text-green-600 mr-2"></i>
            Order Details
          </h3>
          <div class="bg-gray-50 rounded-lg p-4">
            <div class="flex items-center space-x-4">
              <img src="https://upload.wikimedia.org/wikipedia/commons/6/6d/Quran_book.jpg"
                   alt="<%= @order.quran&.title || 'Quran' %>"
                   class="w-20 h-20 object-cover rounded-lg">
              <div class="flex-1">
                <h4 class="font-semibold text-gray-800"><%= @order.quran&.title || "Unknown Quran" %></h4>
                <p class="text-gray-600 text-sm">By <%= @order.quran&.writer || "Unknown" %></p>
                <p class="text-gray-600 text-sm"><%= @order.quran&.pages || 0 %> pages</p>
                <p class="text-gray-600 text-sm">Language: <%= @order.translation&.titleize || "Not specified" %></p>
              </div>
              <div class="text-right">
                <p class="font-semibold text-gray-800">Quantity: <%= @order.quantity %></p>
                <p class="text-green-600 font-medium">FREE</p>
              </div>
            </div>
          </div>

          <!-- Order Summary -->
          <div class="mt-6 bg-green-50 rounded-lg p-4">
            <div class="flex justify-between items-center">
              <span class="font-medium text-gray-700">Total Items:</span>
              <span class="font-semibold text-gray-800"><%= @order.quantity %> copy</span>
            </div>
            <div class="flex justify-between items-center mt-2 pt-2 border-t border-green-200">
              <span class="font-medium text-gray-700">Total Cost:</span>
              <span class="text-xl font-bold text-green-600">FREE</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Quick Actions & Order Info -->
      <div class="space-y-6">
        <!-- Order Actions -->
        <div class="bg-white shadow-lg rounded-xl p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
          <div class="space-y-3">
            <button onclick="updateOrderStatus(<%= @order.id %>, 'processing')" class="w-full bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition">
              <i class="fas fa-cog mr-2"></i>Mark as Processing
            </button>
            <button onclick="updateOrderStatus(<%= @order.id %>, 'shipped')" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
              <i class="fas fa-truck mr-2"></i>Mark as Shipped
            </button>
            <button onclick="updateOrderStatus(<%= @order.id %>, 'delivered')" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
              <i class="fas fa-check-circle mr-2"></i>Mark as Delivered
            </button>
          </div>
        </div>

        <!-- Order Information -->
        <div class="bg-white shadow-lg rounded-xl p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Order Information</h3>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-gray-600">Order ID:</span>
              <span class="font-medium">#<%= @order.id %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Order Date:</span>
              <span class="font-medium"><%= @order.created_at.strftime('%b %d, %Y') %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Order Time:</span>
              <span class="font-medium"><%= @order.created_at.strftime('%I:%M %p') %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">IP Address:</span>
              <span class="font-medium"><%= 'N/A' %></span>
            </div>

            <!-- Order Labels -->
            <div class="pt-3 border-t">
              <div class="flex flex-wrap gap-2">
                <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">Free Shipping</span>
                <span class="px-2 py-1 text-xs bg-purple-100 text-purple-800 rounded-full">Donation</span>
                <% if @order.quantity > 1 %>
                  <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">Bulk Order</span>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <!-- Shipping Address Card -->
        <div class="bg-white shadow-lg rounded-xl p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-map-marker-alt text-red-600 mr-2"></i>
            Shipping Address
          </h3>
          <div class="text-sm text-gray-700 space-y-1">
            <p class="font-medium"><%= @order.full_name %></p>
            <p><%= @order.address %></p>
            <p><%= @order.city %>, <%= @order.state %> <%= @order.postal_code %></p>
            <p><%= @order.country_code %></p>
            <p class="text-gray-600 mt-2"><%= @order.phone %></p>
          </div>

          <!-- Map Link -->
          <div class="mt-4">
            <button class="w-full bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition text-sm">
              <i class="fas fa-map-marked-alt mr-2"></i>View on Map
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- JavaScript for AJAX status updates -->
<script>
  function updateOrderStatus(orderId, newStatus) {
    fetch(`/admin/orders/${orderId}/status`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="authenticity_token"]').value
      },
      body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Show success message
        showFlashMessage('success', 'Order status updated successfully!');
        // Reload page to update status
        setTimeout(() => location.reload(), 1500);
      } else {
        showFlashMessage('error', data.error || 'Failed to update status');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showFlashMessage('error', 'Network error. Please try again.');
    });
  }

  function showFlashMessage(type, message) {
    const existingAlert = document.querySelector('.flash-message');
    if (existingAlert) {
      existingAlert.remove();
    }

    const alertDiv = document.createElement('div');
    alertDiv.className = `flash-message fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white max-w-sm`;
    alertDiv.innerHTML = `
      <div class="flex items-center">
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
        <span>${message}</span>
      </div>
    `;

    document.body.appendChild(alertDiv);

    // Auto-remove after 3 seconds for status updates
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 3000);
  }
</script>
</body>
</html>
